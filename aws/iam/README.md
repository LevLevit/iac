# Overview

This module updates the identify and access management configuration to set up roles and
policies to support System Manager related operations, such as automatic patching, and 
policies, groups, and users for developers and developer admins.

Our goal is to support role-based authentication (RBAC), multi-factor authentication (MFA),
and to house credentials securely on the local machine.  Users, roles, groups, and policies
are provisioned to support this model.  The process for providign keys to users, setting up
~/.aws/config, configuring virtual MFA from the CLI sot that each user can provision his or
her own MFA, and the setup required to use aws-vault is explained below.

# User Management

This module has a variable called "user_groups" in variables.tf that you'll update to 
create your users.  You can put users in one of two groups: dev or dev-admin.  

In addition to creating users and groups we also generate a keypair for each user.  These
keypairs can be used to authenticate users using the AWS CLI.  We do not set up console 
access for users at this time.  

To protect a user's secret key we require that each user provide a GPG public key, which 
we'll use to encrypt the users secret key.  Public keys reside in files under $IAC_HOME/keys.
They are named as ${user}-gpg.pub.

## Using GPG to encrypt generated keypairs

If you don't use GPG to encrypt the secrets generated by Terraform they will be stored
in clear text in the state file(s).  To avoid this we'll use a user's GPG public key
to encrypt his or her key pair secret.  This is provided back to the user encrypted and
they'll use GPG to decrypt it.

### Install

For users, the set up is simple.  You can google how to do this for your OS.  On Mac:

```
brew install gnupg
```

Add the following to whatever you use to initialize environment variables:

```
# GPG
GPG_TTY=$(tty)
export GPG_TTY
```

### Generate keys

```
gpg --generate-key
```

### List keys

```
gpg --list-keys
```

### Copy public key to $IAC_HOME/keys

You can use any attribute of the public key to export it.  I have "Dan" in my full
name so the command below works.  Use --list-keys to find what you need.  The key
will have an identifier that you could use as well or use your e-mail address.

```
gpg --export Dan | base64 > $IAC_HOME/keys/dan-gpg.pub
```

## Decrypt a Key Pair secret

All of the users specified in var.user_groups will get a key pair and the associated
secret will be encrypted with his or her GPG key (stored in $IAC_HOME/keys/user-gpg.pub).  

```
cd $IAC_HOME/aws/iam
terraform output --json | jq -r '.user_key_id.value[]'
```

### Get key and decrypt it

Send an entire stanza to your user.  Note the secret below is edited for brevity.

```
{
  "id": "AKX123...",
  "secret": "wcBURzAiUZHrZulpnTCN7LP+lsmWH/WHjPUBK9h6w7EWsgwUbJauP7Al8I3QmdpcqOxeDB4Gr60UkCVt==",
  "user": "dan.test"
}
```

The user will do something like:

```
echo "wcBMA6VJNd0Ej4fREA3454354345345345345345345345A...==" | base64 --decode | gpg --decrypt 
```

For yourself:

```
terraform output --json | jq -r '.user_key_id.value[] | select(.user=="dan.test") | .secret' \
    | base64 --decode \
    | gpg --decrypt --quiet
```

# Policies

Policies are required to configure role-based authentication (RBAC) and to require MFA, etc.

## Users and Groups

Users have minimal priviledges.  They are able to manage credentials and MFA.  The basic
policies for this are attached to a group that is named after the user.  These policies
are user-specific, allowing access only to the user's own resources.

After the user configures MFA for his account he is able to assume the roles allow by the
policies attached to his group.

## RBAC and MFA

For other actions that a developer or developer admin would require, we create roles and
use role-base authentication, requiring MFA.  Setting up MFA is explained in more detail
below.

Valid roles are:

* platform-test-dev-role
* platform-test-dev-admin-role

### Example user "dan"

The configuration below shows how roles are assumed.  The user is set up with his own 
stanza in the credentials file.  Then, a profile is created in ~/.aws/config for the
environment.  This configuration shows the rule the user will assume and also points 
to the user's MFA device (see below on how to configure MFA).  

#### AWS Credentials

[dan.test]
aws_access_key_id=A..M
aws_secret_access_key=R..Q

#### AWS Config

[profile test]
region         = us-east-2
source_profile = dan.test
role_arn       = arn:aws:iam::12345678910:role/platform-test-dev-role
mfa_serial     = arn:aws:iam::12345678910:mfa/dan.test

## AWS CLI / API Restriction by IP Ranges

The variable "networks" allows you to specify an IP range or ranges that AWS will require
as your source IP range for use of its API.  This allows us to restrict use of the API as
well as ingress to the bastion server by developers when they are not on the correct 
network.  The default allows access from any network.

# Adding Virtual MFA via the AWS CLI

This section talks about how to set up MFA from the AWS CLI.  The create command below 
generates a QR Code.  Use that with your virtual MFA app.  Then make the enable call to
enable the device for the user.  That command requires two generated access codes from
the virtual MFA device.

## Create a Virual MFA Device

```
aws iam create-virtual-mfa-device --virtual-mfa-device-name dan.test --outfile ./qrcode.png --bootstrap-method QRCodePNG --profile dan.test
```

This returns something like:

```
{
    "VirtualMFADevice": {
        "SerialNumber": "arn:aws:iam::12345678910:mfa/dan.test"
    }
}
```
## Enable the Device

```
aws iam enable-mfa-device \
    --profile dan.test \
    --user-name dan.test \
    --serial-number arn:aws:iam::12345678910:mfa/dan.test" \
    --authentication-code1 123456 \
    --authentication-code2 789012
```
# AWS Vault

AWS valut will allow you to store your credentials securely.  This means that you end
up with an empty ~/.aws/credentials file.  See https://github.com/99designs/aws-vault. It 
will also allow users to

* Rotate credentials
* Clear stored sessions
* Remove credentials from the vault
* Nicely prompt for MFA

## Install

```
brew install aws-vault
```

## Add Credentials to AWS Vault

```
aws-vault add dan.test
```

It will prompt for access key and access key secret.

## Update ~/.aws/config

```
[profile dan.test]
region             = us-east-2
credential_process = /usr/local/bin/aws-vault exec -j --prompt=osascript dan.test 
mfa_serial         = arn:aws:iam::12345678910:mfa/dan.test

[profile dan.test.dev]
region          = us-east-2
source_profile  = dan.test
include_profile = dan.test
role_arn        = arn:aws:iam::12345678910:role/platform-test-dev-role

[profile dan.test.admin]
region          = us-east-2
source_profile  = dan.test
include_profile = dan.test
role_arn        = arn:aws:iam::12345678910:role/platform-test-dev-admin-role
```

* The setup above uses MFA for the user dan.test 
* dan.test is part of the dev and dev-admin groups and can assume both roles 
* By passing --profile parameter to the CLI, we're able to assume the appropriate role
* Note the credentials_process uses AWS Vault
* The --prompt parameter provides a GUI prompt on MacOS

This is the same setup necessary for your terraform user if you follow the instructions
in [AWS Setup](../README.md#option-2-rbac-with-mfa).

## Terraform

Note that I initially received the following error running Terraform vs. the AWS CLI:

```
AssumeRoleTokenProviderNotSetError when using assume_role with mfa enabled
```

This required the following updates to the original configuration.

* Moved the mfa_serial line up from the role to the base profile
* Added include_profile in the role-based profiles

See https://github.com/hashicorp/terraform-provider-aws/issues/10491 for details.

After the above changes it works like a champ.  Perhaps at some point the config
will become simpler but for now the workarounds aren't onerous.

# IAM and MFA

When you make calls related to IAM, AWS is not going to authorized the call if you have
an account that is MFA enabled but hasn't passed MFA tokens.  In this particular case 
the command below should work before MFA is enabled but not after.

```
aws iam list-users --profile dan.test
```

After MFA is enabled, you will need to do the following:

```
aws-vault exec dan.test --no-session -- aws iam list-users
```

See https://github.com/99designs/aws-vault/issues/260 for details.

Alternatively, add MFA so that the normal CLI 'aws iam list-users --profile dan.test' works
with MFA.  In the example ~/.aws/config above note the line for MFA under the dan.test 
profile.

```
mfa_serial         = arn:aws:iam::12345678910:mfa/dan.test
```