# Using GPG to encrypt generated keypairs

If you don't use GPG to encrypt the secrets generated by Terraform they will be stored
in clear text in the state file(s).  To avoid this we'll use a user's GPG public key
to encrypt his or her key pair secret.  This is provided back to the user encrypted and
they'll use GPG to decrypt it.

## Setup

For users, the set up is simple.  You can google how to do this for your OS.  On Mac:

```
brew install gnupg
```

## Generate keys

```
gpg --gen-keys
```

## List keys

```
gpg --list-keys
```

## Copy public key to $IAC_HOME/keys/gpg

You can use any attribute of the public key to export it.  I have "Dan" in my full
name so the command below works.  Use --list-keys to find what you need.  The key
will have an identifier that you could use as well or use your e-mail address.

```
gpg --export Dan | base64 > $IAC_HOME/keys/dan-gpg.pub
```

# Decrypt a Key Pair secret

All of the users specified in var.user_groups will get a key pair and the associated
secret will be encrypted with his or her GPG key (stored in $IAC_HOME/keys/user-gpg.pub).  

```
cd $IAC_HOME/aws/iam
terraform output --json | jq -r '.user_key_id.value[]'
```

## Get key and decrypt it

Send an entire stanza to your user.  Note the secret below is edited for brevity.

```
{
  "id": "AKX123...",
  "secret": "wcBURzAiUZHrZulpnTCN7LP+lsmWH/WHjPUBK9h6w7EWsgwUbJauP7Al8I3QmdpcqOxeDB4Gr60UkCVt==
  "user": "dan.test"
}
```

The user will do something like:

```
echo "wcBMA6VJNd0Ej4fREA3454354345345345345345345345A...==" | base64 --decode | gpg --decrypt 
```

For yourself:

```
terraform output --json | jq -r '.user_key_id.value[] | select(.user=="dan.test") | .secret' \
    | base64 --decode \
    | gpg --decrypt --quiet
```